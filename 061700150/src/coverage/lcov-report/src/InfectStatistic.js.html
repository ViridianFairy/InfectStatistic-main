<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src\InfectStatistic.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">src/</a> InfectStatistic.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">15.09% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>16/106</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">1.67% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>1/60</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">40% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>2/5</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">15.79% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>15/95</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">const fs = require('fs')  //读写文件的自带库
const prior = require('./Lib.js')
const MONTH = [0, 31, 28, 30, 51, 30, 31, 31, 30, 31, 30, 31]  //月份常量
const Provinces = new Set()  //存放省份的集合
const Total = {  //存放统计数据
   ip: {}, sp: {}, dead: {}, cure: {},
}
const CmdParam = {  //存放命令参数
   log: [], out: [], date: [], type: [], province: [],
}
const REG = [
   /(\S{2,3})\s新增 感染患者 (\d+)人/g,
   /(\S{2,3})\s新增 疑似患者 (\d+)人/g,
   /(\S{2,3})\s疑似患者 流入 (\S{2,3})\s(\d+)人/g,
   /(\S{2,3})\s感染患者 流入 (\S{2,3})\s(\d+)人/g,
   /(\S{2,3})\s死亡 (\d+)人/g,
   /(\S{2,3})\s治愈 (\d+)人/g,
   /(\S{2,3})\s疑似患者 确诊感染 (\d+)人/g,
   /(\S{2,3})\s排除 疑似患者 (\d+)人/g,
]
var reading = '',
   article = '',
   argv = process.argv.slice(2),
   cmd = argv.join(' ')
<span class="fstat-no" title="function not covered" >function appendData(date) {</span>
<span class="cstat-no" title="statement not covered" >   var fileName = CmdParam.log[0] + date + '.log.txt' </span>//组合文件
<span class="cstat-no" title="statement not covered" >   if (!fs.existsSync(fileName)) <span class="cstat-no" title="statement not covered" >return </span></span> //如果没有对应日期的文件，就忽略 
<span class="cstat-no" title="statement not covered" >   var data = fs.readFileSync(fileName, 'utf-8') </span> //效率非常低的同步读取
<span class="cstat-no" title="statement not covered" >   data = data.split('\n') </span>  //分行
<span class="cstat-no" title="statement not covered" >   data.forEach((line) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >      var res = []</span>
<span class="fstat-no" title="function not covered" >      function match(reg, hasTwoPvovinces) {</span> //匹配正则，清洗数据以及初始化
<span class="cstat-no" title="statement not covered" >         if (/\/\//.test(line)) <span class="cstat-no" title="statement not covered" >return false </span></span>//如果是注释，忽略掉
<span class="cstat-no" title="statement not covered" >         var res = reg.exec(line)</span>
<span class="cstat-no" title="statement not covered" >         if (!res) <span class="cstat-no" title="statement not covered" >return</span></span>
<span class="cstat-no" title="statement not covered" >         for (key of Object.keys(Total)) { //初始化数据数字为Number类型，防止NaN</span>
<span class="cstat-no" title="statement not covered" >            if (!Total[key][res[1]]) { //非undefined类型代表已经初始化过</span>
<span class="cstat-no" title="statement not covered" >               Provinces.add(res[1]) </span> //顺便收集唯一省份
<span class="cstat-no" title="statement not covered" >               Total[key][res[1]] = 0</span>
            }
<span class="cstat-no" title="statement not covered" >            if (hasTwoPvovinces &amp;&amp; !Total[key][res[2]]) { //同上，并且判断要收集第三项数据</span>
<span class="cstat-no" title="statement not covered" >               Provinces.add(res[2]) </span> //顺便收集唯一省份
<span class="cstat-no" title="statement not covered" >               Total[key][res[2]] = 0</span>
            }
         }
<span class="cstat-no" title="statement not covered" >         return res.slice(1, 4) </span>//返回正则匹配的组内容
      }
<span class="cstat-no" title="statement not covered" >      if (res = match(REG[0])) //正则</span>
<span class="cstat-no" title="statement not covered" >         Total.ip[res[0]] += Number(res[1])  </span>
      else <span class="cstat-no" title="statement not covered" >if (res = match(REG[1]))</span>
<span class="cstat-no" title="statement not covered" >         Total.sp[res[0]] += Number(res[1])</span>
      else <span class="cstat-no" title="statement not covered" >if (res = match(REG[2], true)) {</span>
<span class="cstat-no" title="statement not covered" >         Total.sp[res[0]] -= Number(res[2])</span>
<span class="cstat-no" title="statement not covered" >         Total.sp[res[1]] += Number(res[2])</span>
      }
      else <span class="cstat-no" title="statement not covered" >if (res = match(REG[3], true)) {</span>
<span class="cstat-no" title="statement not covered" >         Total.ip[res[0]] -= Number(res[2])</span>
<span class="cstat-no" title="statement not covered" >         Total.ip[res[1]] += Number(res[2])</span>
      }
      else <span class="cstat-no" title="statement not covered" >if (res = match(REG[4])) {</span>
<span class="cstat-no" title="statement not covered" >         Total.ip[res[0]] -= Number(res[1])</span>
<span class="cstat-no" title="statement not covered" >         Total.dead[res[0]] += Number(res[1])</span>
      }
      else <span class="cstat-no" title="statement not covered" >if (res = match(REG[5])) {</span>
<span class="cstat-no" title="statement not covered" >         Total.cure[res[0]] += Number(res[1])</span>
<span class="cstat-no" title="statement not covered" >         Total.ip[res[0]] -= Number(res[1])</span>
      }
      else <span class="cstat-no" title="statement not covered" >if (res = match(REG[6])) {</span>
<span class="cstat-no" title="statement not covered" >         Total.ip[res[0]] += Number(res[1])</span>
<span class="cstat-no" title="statement not covered" >         Total.sp[res[0]] -= Number(res[1])</span>
      }
      else <span class="cstat-no" title="statement not covered" >if (res = match(REG[7]))</span>
<span class="cstat-no" title="statement not covered" >         Total.sp[res[0]] -= Number(res[1])</span>
   })
}
function washCmdParam(){
   <span class="missing-if-branch" title="else path not taken" >E</span>if(argv[0]!='list') throw new Error('仅能接受list命令！')
<span class="cstat-no" title="statement not covered" >   argv.slice(1).forEach(v =&gt; {</span>
<span class="cstat-no" title="statement not covered" >      var checked = false </span> //checked为true，说明该参数是一个以-为前缀的key
<span class="cstat-no" title="statement not covered" >      for (item of Object.keys(CmdParam))</span>
<span class="cstat-no" title="statement not covered" >         if (v == '-' + item) {</span>
<span class="cstat-no" title="statement not covered" >            reading = item</span>
<span class="cstat-no" title="statement not covered" >            checked = true</span>
<span class="cstat-no" title="statement not covered" >            break</span>
         }
<span class="cstat-no" title="statement not covered" >      !checked &amp;&amp; CmdParam[reading].push(v) </span>//统计键值对
   })
<span class="cstat-no" title="statement not covered" >   if(!fs.existsSync(CmdParam.log[0])) <span class="cstat-no" title="statement not covered" >throw new Error('输入的日志目录不存在！')</span></span>
<span class="cstat-no" title="statement not covered" >   if (fs.readdirSync(CmdParam.log[0]).sort().reverse()[0].split('.')[0] &lt; CmdParam.date[0])</span>
<span class="cstat-no" title="statement not covered" >      throw new Error('日期超出范围！（-date不会提供在日志最晚一天后的日期）');</span>
<span class="cstat-no" title="statement not covered" >   if (!CmdParam.date[0]) </span>
<span class="cstat-no" title="statement not covered" >      return fs.readdirSync(CmdParam.log[0]).sort().reverse()[0].split('.')[0].split('-') </span>//最大日期
   else //指定了日期
<span class="cstat-no" title="statement not covered" >      return CmdParam.date[0].split('-')</span>
}
<span class="fstat-no" title="function not covered" >function print(){</span>
<span class="cstat-no" title="statement not covered" >   var provincesSorted = []</span>
<span class="cstat-no" title="statement not covered" >   for (let item of Provinces.keys()) { //提取集合里的省份</span>
<span class="cstat-no" title="statement not covered" >      provincesSorted.push(item)</span>
   }
<span class="cstat-no" title="statement not covered" >   provincesSorted = provincesSorted.sort((a, b) =&gt; { //进行汉字拼音排序</span>
<span class="cstat-no" title="statement not covered" >      return prior.indexOf(a) - prior.indexOf(b)</span>
   })
<span class="cstat-no" title="statement not covered" >   for (let item of Object.keys(Total)) {  //统计'全国'的数据</span>
<span class="cstat-no" title="statement not covered" >      let sum = 0</span>
<span class="cstat-no" title="statement not covered" >      for (let num of Object.values(Total[item]))</span>
<span class="cstat-no" title="statement not covered" >         sum += num</span>
<span class="cstat-no" title="statement not covered" >      Total[item]['全国'] = sum</span>
   }
<span class="cstat-no" title="statement not covered" >   provincesSorted.unshift('全国') </span>//确保‘全国’一定在其他省份的前面
<span class="cstat-no" title="statement not covered" >   if (!CmdParam.type.length) <span class="cstat-no" title="statement not covered" >CmdParam.type = ['ip', 'sp', 'cure', 'dead'] </span></span>// 不指定-type即为输出全部四项
<span class="cstat-no" title="statement not covered" >   provincesSorted.forEach((v) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >      if (!(CmdParam.province.length == 0 || CmdParam.province.includes(v))) <span class="cstat-no" title="statement not covered" >return </span></span>//筛选-province省份
<span class="cstat-no" title="statement not covered" >      article += `${v}` </span>  //开始处理输出数据的附加项-type
<span class="cstat-no" title="statement not covered" >      if (CmdParam.type.includes('ip')) <span class="cstat-no" title="statement not covered" >article += ` 感染患者${Total.ip[v]}人`</span></span>
<span class="cstat-no" title="statement not covered" >      if (CmdParam.type.includes('sp')) <span class="cstat-no" title="statement not covered" >article += ` 疑似患者${Total.sp[v]}人`</span></span>
<span class="cstat-no" title="statement not covered" >      if (CmdParam.type.includes('cure')) <span class="cstat-no" title="statement not covered" >article += ` 治愈${Total.cure[v]}人`</span></span>
<span class="cstat-no" title="statement not covered" >      if (CmdParam.type.includes('dead')) <span class="cstat-no" title="statement not covered" >article += ` 死亡${Total.dead[v]}人`</span></span>
<span class="cstat-no" title="statement not covered" >      article += `\n`</span>
   })
<span class="cstat-no" title="statement not covered" >   article += `// 该文档并非真实数据，仅供测试使用\n// 命令：node InfectStatistic ${cmd}`</span>
<span class="cstat-no" title="statement not covered" >   fs.writeFileSync(CmdParam.out[0], article, 'utf-8') </span> //最后写入文件
}
(module.export = function main() {  //若要开始单元测试。。。改变arguments以及washCmdParam()
   var [y,m,d] = washCmdParam()
<span class="cstat-no" title="statement not covered" >   for (var i = 1; i &lt;= m; i++){ //不循环年份，因为老爷说了，19年没有叫这个名的病毒</span>
<span class="cstat-no" title="statement not covered" >      for (var j = 1; j &lt;= (i != m ? MONTH[i] : d); j++) {</span>
<span class="cstat-no" title="statement not covered" >         appendData(`2020-${i &lt;= 9 ? '0' + i : i}-${j &lt;= 9 ? '0' + j : j}`)</span>
      }
   }
<span class="cstat-no" title="statement not covered" >   print()</span>
})()
<span class="cstat-no" title="statement not covered" >process.on('uncaughtException', (e) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >   console.error('错误：', e.message) </span>  //若要开始单元测试。。。改为article拼接
})</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Feb 14 2020 20:27:41 GMT+0800 (GMT+08:00)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
